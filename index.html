<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>I’m Adopted – Frame Generator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, Arial, sans-serif;
      background: #f4f8fb;
      color: #222;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      text-align: center;
      padding: 1.5rem;
    }
    h1 { margin: 0; font-size: 1.6rem; color: #0b6efb; }
    main { width: 100%; max-width: 420px; padding: 0 1rem 2rem; }
    .preview {
      position: relative;
      aspect-ratio: 1/1;
      border-radius: 50%;
      overflow: hidden;
      background: #eee;
      margin-bottom: 1rem;
    }
    canvas { width: 100%; height: 100%; display: block; }
    .upload-btn, button {
      width: 100%;
      margin: .5rem 0;
      padding: .8rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      text-align: center;
      cursor: pointer;
    }
    .upload-btn {
      background: #0b6efb;
      color: #fff;
      display: inline-block;
    }
    .upload-btn:hover { background: #0956c6; }
    button {
      background: #0b6efb;
      color: #fff;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    footer { font-size: .8rem; opacity: .7; padding-bottom: 1rem; text-align: center; }
    .helper { font-size: 0.85rem; opacity: 0.8; margin-top: 0.5rem; text-align: center; }
    #status { font-size: 0.9rem; color: #555; margin: 0.5rem 0; text-align: center; }
  </style>
</head>
<body>
  <header>
    <h1>Add the I’m Adopted Frame</h1>
    <p>Upload your photo and download it with our campaign frame.</p>
  </header>

  <main>
    <div class="preview">
      <canvas id="canvas"></canvas>
    </div>

    <!-- Upload button -->
    <label for="upload" class="upload-btn">Upload Photo</label>
    <input type="file" id="upload" accept="image/*" hidden>

    <div id="status"></div>

    <!-- Download buttons -->
    <button id="download" disabled>Download PNG</button>
    <button id="open" disabled style="background:#444;">Open in New Tab</button>

    <p class="helper">On iPhone/iPad: if the image opens in a new tab, long-press it and choose “Save Image.”</p>
  </main>

  <footer>
    © I’m Adopted – Supporting Adoptee Mental Health
  </footer>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const fileInput = document.getElementById('upload');
const downloadBtn = document.getElementById('download');
const openBtn = document.getElementById('open');
const status = document.getElementById('status');

let photo = null, overlay = new Image();
let scale = 1, offsetX = 0, offsetY = 0, dragging = false, startX=0, startY=0;

canvas.width = 800; canvas.height = 800;

// Load overlay (replace with your hosted PNG URL)
overlay.src = "overlay.png"; // <-- change this to your Squarespace/hosted PNG link
overlay.onload = draw;

// Upload photo
fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onloadstart = () => { status.innerText = "Loading photo..."; };
  reader.onload = ev => {
    photo = new Image();
    photo.onload = () => {
      fitImage();
      draw();
      downloadBtn.disabled = false;
      openBtn.disabled = false;
      status.innerText = "";
    };
    photo.src = ev.target.result;
  };
  reader.onloadend = () => { status.innerText = ""; };
  reader.readAsDataURL(file);
});

// Fit uploaded photo to canvas
function fitImage(){
  const s = Math.max(canvas.width/photo.width, canvas.height/photo.height);
  scale = s; offsetX = (canvas.width - photo.width*scale)/2; offsetY = (canvas.height - photo.height*scale)/2;
}

// Draw everything
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Clip to circle
  ctx.save();
  ctx.beginPath();
  ctx.arc(canvas.width/2, canvas.height/2, canvas.width/2, 0, Math.PI*2);
  ctx.clip();
  // User photo
  if (photo) ctx.drawImage(photo, offsetX, offsetY, photo.width*scale, photo.height*scale);
  ctx.restore();
  // Overlay on top
  if (overlay.complete) ctx.drawImage(overlay,0,0,canvas.width,canvas.height);
}

// Drag to move
canvas.addEventListener('pointerdown', e => { dragging = true; startX=e.clientX; startY=e.clientY; });
canvas.addEventListener('pointermove', e => {
  if (!dragging) return;
  offsetX += e.clientX-startX; offsetY += e.clientY-startY;
  startX = e.clientX; startY = e.clientY;
  draw();
});
canvas.addEventListener('pointerup', ()=> dragging=false);
canvas.addEventListener('pointerleave', ()=> dragging=false);

// Zoom with wheel/pinch
canvas.addEventListener('wheel', e => {
  e.preventDefault();
  const delta = Math.exp(-e.deltaY/300);
  scale *= delta;
  draw();
},{passive:false});

// Export as PNG
function exportImage(openTab=false){
  const url = canvas.toDataURL('image/png');
  if (openTab){
    const w = window.open();
    w.document.write('<title>Save your frame</title><img style="width:100%;height:auto" src="'+url+'">');
    w.document.close();
  } else {
    const a = document.createElement('a');
    a.href = url;
    a.download = 'imadopted-frame.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  }
}

downloadBtn.addEventListener('click', ()=> exportImage(false));
openBtn.addEventListener('click', ()=> exportImage(true));
</script>
</body>
</html>
